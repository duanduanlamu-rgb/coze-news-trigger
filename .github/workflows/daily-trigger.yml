name: Daily Coze News Trigger

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 = UTC 0:00ï¼ˆå‡8å°æ—¶ï¼‰
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Current Date
      id: date
      run: |
        # ä½¿ç”¨åŒ—äº¬æ—¶åŒºè·å–æ—¥æœŸ
        TZ='Asia/Shanghai' date +'%mæœˆ%dæ—¥' > date.txt
        echo "today=$(cat date.txt)" >> $GITHUB_OUTPUT
        echo "ğŸ“… å½“å‰æ—¥æœŸ: $(cat date.txt)"
    
    - name: Trigger Coze Workflow
      run: |
        response=$(curl -w "\nHTTP_CODE:%{http_code}" -X POST \
          'https://api.coze.cn/v1/workflow/stream_run' \
          -H 'Authorization: Bearer ${{ secrets.COZE_TOKEN }}' \
          -H 'Content-Type: application/json' \
          -d '{
            "workflow_id": "7572968865026588722",
            "parameters": {
              "mail_ac": "${{ secrets.MAIL_AC }}",
              "mail_pw": "${{ secrets.EMAIL_PWD }}",
              "time": "'"${{ steps.date.outputs.today }}"'",
              "to_mail_ac": "${{ secrets.TO_MAIL_AC }}"
            }
          }')
        
        echo "=== å“åº”å†…å®¹ ==="
        echo "$response"
        
        http_code=$(echo "$response" | grep "HTTP_CODE" | cut -d: -f2)
        echo "=== HTTP çŠ¶æ€ç : $http_code ==="
        
        if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
          echo "âœ… API è°ƒç”¨æˆåŠŸ"
        else
          echo "âš ï¸ API è¿”å›çŠ¶æ€ç : $http_code"
        fi
    
    - name: Show Success
      run: |
        echo "âœ… æ‰£å­æ–°é—»å·¥ä½œæµè§¦å‘æˆåŠŸï¼"
        echo "ğŸ“… æ—¥æœŸ: ${{ steps.date.outputs.today }}"
